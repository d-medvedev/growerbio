On wtrTmrEvt do 
 TaskValueSet Wtr, Sts,1
 TaskValueSet Wtr, Cntr, [Wtr#Cntr]+1
 Publish,%sysname%/Wtr/Sts,1
 Publish,%sysname%/Wtr/Cntr,[Wtr#Cntr]
 Let,10,60*[WtrSgs#wtrDrtn]
 GPIO [rlPins#wtr],1
 timerSet,5,%v10%
Endon

On Rules#Timer=5 do
 GPIO [rlPins#wtr],0
 TaskValueSet Wtr, Sts, 0
 Publish,%sysname%/Wtr/Sts,0
Endon

On MqAutoCtrl#wtrAuto Do
TaskValueSet AutoCtrlSgs, wtr,%eventvalue%
 If %eventvalue% = 1
  TaskValueSet ManCtrlSgs,wtr,0
 Endif
 If [Wtr#Ena]
 TaskValueSet Wtr,Cntr,[WtrSgs#wtrCntr]*(%v7%-%v5%)/(([LtSgs#dDrtn]-[WtrSgs#wtrShft])*3600)
 Endif
 If [AutoCtrlSgs#wtr] = 0 And [ManCtrlSgs#wtr] = 0
 GPIO [rlPins#wtr],0
 TaskValueSet Wtr, Sts, 0
 TaskValueSet,Wtr,Cntr,0
 TaskValueSet TmEvtCntr,wtr,0
Endif
Endon

On MqWtrSgs#wtrCntr Do
 TaskValueSet,WtrSgs, wtrCntr,%eventvalue%
Endon

On MqWtrSgs#wtrDrtn Do
 TaskValueSet WtrSgs, wtrDrtn,%eventvalue%
Endon

On MqWtrSgs#wtrShft Do
 TaskValueSet,WtrSgs, wtrShft,%eventvalue%
Endon

On MqRlCtrl#wtr Do
TaskValueSet ManCtrlSgs, wtr,%eventvalue%
If %eventvalue% = 1
  timerSet,5,0
  TaskValueSet AutoCtrlSgs, wtrAuto,0
 Endif 
 GPIO [rlPins#wtr],%eventvalue%
 TaskValueSet Wtr, Sts, %eventvalue%
Endon

On cfgWtrTsk Do
TaskValueSet Wtr,Ena,1
If [WtrSgs#wtrCntr] = 0
 TaskValueSet WtrSgs,wtrCntr,12
Endif
If [WtrSgs#wtrDrtn] = 0
 TaskValueSet WtrSgs,wtrDrtn,7
Endif
If [WtrSgs#wtrShft] = 0
 TaskValueSet WtrSgs, wtrShft, 1
Endif
If [WtrSgs#wtrwtrInvl] = 0
 TaskValueSet WtrSgs,wtrIntvl,1*3600+25*60
Endif
If [rlPins#wtr] = 0
 TaskValueSet rlPins, wtr, 26
Endif
If [AutoCtrlSgs#wtrAuto] = 0 And [ManCtrlSgs#wtr] = 0
 GPIO [rlPins#wtr],0
 TaskValueSet Wtr, Sts, 0
 TaskValueSet AutoCtrlSgs, wtrAuto, 1
Endif
Endon
On updWtrSgs Do
 Publish,%sysname%/settings/wat_cnt,[WtrSgs#wtrCntr]
 Publish,%sysname%/settings/wat_dur,[WtrSgs#wtrDrtn]
 Publish,%sysname%/settings/wat_offset,[WtrSgs#wtrShft]
 Publish,%sysname%/settings/water_auto,[AutoCtrlSgs#wtr]
 Publish,%sysname%/settings/wat_intvl,[WtrSgs#wtrIntvl]
Endon